var Sv={requestPost:function(a,b,c,d,e){Ext.Ajax.request({url:Ext.actualUrl(a),method:"POST",params:b,jsonData:c,success:function(a){var b=Ext.decode(a.responseText);b.success?Ext.isFunction(e)&&e(b):(d&&Ext.MessageBox.alert("提示信息",b.message),Ext.log.warn(b.message))},failure:function(b){d&&Ext.MessageBox.alert("提示信息","提示信息","请求失败!"),Ext.log.error("提示信息",a+"请求失败!")}})},requestPostParams:function(a,b,c){this.requestPost(a,b,null,!0,c)},requestPostJsonData:function(a,b,c){this.requestPost(a,null,b,!0,c)},requestPostNoAsync:function(a,b,c,d){var e=null;return void 0==d&&(d=!0),Ext.Ajax.request({url:Ext.actualUrl(a),method:"POST",params:b,jsonData:c,async:!1,success:function(a){var b=Ext.decode(a.responseText);b.success?e=b:(d&&Ext.MessageBox.alert("提示信息",b.message),Ext.log.warn(b.message))},failure:function(b){d&&Ext.MessageBox.alert("提示信息","提示信息","请求失败!"),Ext.log.error("提示信息",a+"请求失败!")}}),e},requestPostNoAsyncParams:function(a,b){return this.requestPostNoAsync(a,b,null,!0)},requestPostNoAsyncJsonData:function(a,b){return this.requestPostNoAsync(a,null,b,!0)}};Ext.QuickTips.init(),Ext.form.field.Date.override({reset:function(){var a=this;a.callParent(),a.setMaxValue(),a.setMinValue()}}),Ext.data.Store.override({getRecordsValues:function(){var a,b=this.getRange()||[],c=[];for(a=0;a<b.length;a++){var d,e={};d=Ext.apply(e,b[a].data),Ext.isObject(d)&&c.push(d)}return c}}),Ext.grid.column.Column.override({bindFormatter:function(a){var b=this;return function(c){return Ext.isObject(c)&&b.dataChild?a(c[b.dataChild],b.rendererScope||b.resolveListenerScope()):a(c,b.rendererScope||b.resolveListenerScope())}}}),Ext.define("Sv.Ext.grid.Panel",{extend:"Ext.grid.Panel",alias:"widget.svgrid",isFormField:!0,initComponent:function(){this.callParent(arguments)},setValue:function(a){this.store&&(this.store.setData(a),this.store.save())},getValue:function(){return getSubmitData()},getSubmitData:function(){var a=this,b=null,c=a.getSubmitValue();return!a.disabled&&c&&(b={},b[a.getName()]=c),b},getName:function(){return this.name},getSubmitValue:function(){if(this.store)return this.store.getRecordsValues()},isValid:function(){return!0},validate:function(){return this.isValid()},isDirty:function(){return this.store.getNewRecords().length>0||this.store.getUpdatedRecords().length>0||this.store.getRemovedRecords().length>0},save:function(){if(this.store)return this.store.save()},setReadOnly:function(a){for(var b=this.getColumns(),c=0,d=b.length;c<d;c++)if(b[c].dataIndex&&""!=b[c].dataIndex&&b[c].getEditor){var e=b[c].getEditor();e&&e.setReadOnly&&e.setReadOnly(a)}var f=this.query("*[readOnlyHide=true]");if(Ext.isIterable(f))for(var c=0;c<f.length;++c)a?f[c].hide():f[c].show()},reset:function(){this.store&&this.store.removeAll()}}),Ext.define("Sv.util.Format",{override:"Ext.util.Format",chMoney:function(a){var b=this.number(a,",0.00");return 0==a?"<span style='color:#bababa'>"+b+"</span>":a<0?"<span style='color:#cf4c35'>"+b+"</span>":"<span style='color:#000000'>"+b+"</span>"},formState:function(a){switch(a){case 0:return"草稿";case 1:return"提交";case 2:return"审核中";case 3:return"确认中";case 4:return"办理中";case 8:return"结束";case 9:return"作废";default:return"未知"}}}),Ext.define("Sv.WinView",{extend:"Ext.window.Window",modal:!0,closeAction:"hide",on_hide:null,loader:{renderer:"frame",url:"about:blank",loadMask:"加载中......"},open:function(a,b,c){this.setTitle(a),this.show(),this.loader.url=b,this.loader.load(),this.on_hide=c},listeners:{hide:function(){this.loader.url="about:blank",this.loader.load(),this.on_hide&&Ext.isFunction(this.on_hide)&&this.on_hide(),this.on_hide=null}}}),Ext.getWinView=function(){var a=null;return window.top.Bil&&(a=window.top.Bil.getAppWin()),a||(a=Ext.create("Sv.WinView",{resizable:!1,maximized:!0})),a},Ext.grid.column.Check.override({listeners:{beforecheckchange:function(){return!this.stopSelection}}}),Ext.define("Ext.my.util.Sorter",{override:"Ext.util.Sorter",sortFn:function(a,b){var c,d,e=this,f=e._transform,g=e._root,h=e._property;return g&&(a=a[g],b=b[g]),c=a[h],d=b[h],f&&(c=f(c),d=f(d)),"string"==typeof c?c.localeCompare(d):c>d?1:c<d?-1:0}}),Ext.define("Sv.ComponentLoader",{override:"Ext.ComponentLoader",autoLoad:!0,removeD:!1,constructor:function(a){a=a||{};var b=a.autoLoad;if(a.autoLoad=!1,this.superclass.constructor.call(this,a),!1!==b&&(this.autoLoad=!0),"frame"==this.renderer){var c=this.getTarget();if(!c.isContainer)throw"IFrame can only be loader to a container";c.layout="fit"}var d={delay:10,single:!0},e=this.triggerControl||this.getTarget(),f=this.triggerEvent,g=e instanceof Ext.container.Container?"afterlayout":"afterrender";d.single=!this.reloadOnEvent,this.autoLoad&&(e.on(g,function(){this.load({})},this,d),f&&e.on(f,function(){this.load({})},this,d))},load:function(a){if(Ext.isString(a)?(this.url=a,a={url:a}):a=Ext.apply({},a),this.lastOptions=a,"frame"==this.renderer)return void this.loadFrame(a)},loadFrame:function(a){a=Ext.apply({},a);var b=this,c=b.getTarget(),d=Ext.isDefined(a.loadMask)?a.loadMask:b.loadMask,e=Ext.isDefined(a.disableCaching)?a.disableCaching:b.disableCaching,f=a.disableCachingParam||"_dc",g=Ext.apply({},a.params);if(Ext.applyIf(g,b.params),Ext.apply(g,b.baseParams),Ext.applyIf(a,{url:b.url}),Ext.apply(a,{mask:d,disableCaching:e,params:g}),this.lastOptions=a,!a.url)throw"No URL specified";var h=a.url;if(!1!==e&&(h=h+(h.indexOf("?")>-1?"&":"?")+f+"="+(new Date).getTime()),!Ext.Object.isEmpty(g)){var i={};for(var j in g){var k=g[j];i[j]="function"==typeof k?k.call(c):k}i=Ext.urlEncode(i),h=h+(h.indexOf("?")>-1?"&":"?")+i}Ext.isEmpty(c.iframe)?(c.iframe=new Ext.ux.IFrame({id:c.id+"_IFrame",loadMask:Ext.isString(d)?d:d.msg?d.msg:"加载中......",listeners:{destroy:function(){var a=this.getFrame();a&&a.parentNode&&(a.src="about:blank",a.parentNode.removeChild(a))},load:function(){var a=this.getWin();a&&(a.target=c)}}}),c.add(c.iframe),c.iframe.load(h)):c.iframe.load(h)}}),Ext.define("Sv.view.SearchTrigger",{extend:"Ext.form.field.Text",alias:"widget.searchtrigger",setFilter:function(a,b){var c=this.up("grid").getStore();if(b){c.removeFilter(a,!1);var d={id:a,property:a,value:b};this.anyMatch&&(d.anyMatch=this.anyMatch),this.caseSensitive&&(d.caseSensitive=this.caseSensitive),this.exactMatch&&(d.exactMatch=this.exactMatch),this.operator&&(d.operator=this.operator),c.addFilter(d)}else c.filters.removeAtKey(a),c.reload()},listeners:{render:function(){var a=this;a.ownerCt.on("resize",function(){a.setWidth(this.getEl().getWidth())})},change:function(){this.setFilter(this.up().dataIndex,this.getValue())}}}),Ext.define("Ext.app.Portlet",{extend:"Ext.panel.Panel",alias:"widget.portlet",layout:"fit",anchor:"100%",frame:!0,closable:!0,collapsible:!0,animCollapse:!0,draggable:{moveOnDrag:!1},resizeHandles:"s",resizable:!0,cls:"x-portlet",doClose:function(){this.closing||(this.closing=!0,this.el.animate({opacity:0,scope:this,callback:function(){var a=this.closeAction;this.closing=!1,this.fireEvent("close",this),this[a](),"hide"==a&&this.el.setOpacity(1)}}))}}),Ext.define("Ext.app.PortalColumn",{extend:"Ext.container.Container",alias:"widget.portalcolumn",layout:"anchor",defaultType:"portlet",cls:"x-portal-column"}),Ext.define("Ext.app.PortalPanel",{extend:"Ext.panel.Panel",alias:"widget.portalpanel",cls:"x-portal",bodyCls:"x-portal-body",defaultType:"portalcolumn",autoScroll:!0,initComponent:function(){this.layout={type:"column"},this.callParent(),this.on("drop",this.updateLayout,this)},beforeLayout:function(){var a,b=this.layout.getLayoutItems(),c=b.length,d=0,e=1,f=c;for(d=0;d<c;d++)a=b[d],a.columnWidth&&(e-=a.columnWidth||0,f--);for(d=0;d<c;d++)a=b[d],a.columnWidth||(a.columnWidth=e/f),a.removeCls(["x-portal-column-first","x-portal-column-last"]);return b.length>0&&(b[0].addCls("x-portal-column-first"),b[c-1].addCls("x-portal-column-last")),this.callParent(arguments)},initEvents:function(){this.callParent(),this.dd=Ext.create("Ext.app.PortalDropZone",this,this.dropConfig)},beforeDestroy:function(){this.dd&&this.dd.unreg(),this.callParent()}}),Ext.define("Ext.app.PortalDropZone",{extend:"Ext.dd.DropTarget",constructor:function(a,b){this.portal=a,Ext.dd.ScrollManager.register(a.body),Ext.app.PortalDropZone.superclass.constructor.call(this,a.body,b),a.body.ddScrollConfig=this.ddScrollConfig},ddScrollConfig:{vthresh:50,hthresh:-1,animate:!0,increment:200},createEvent:function(a,b,c,d,e,f){return{portal:this.portal,panel:c.panel,columnIndex:d,column:e,position:f,data:c,source:a,rawEvent:b,status:this.dropAllowed}},notifyOver:function(a,b,c){var d=b.getXY(),e=this.portal,f=a.proxy;this.grid||(this.grid=this.getGrid());var g=e.body.dom.clientWidth;this.lastCW?this.lastCW!=g&&(this.lastCW=g,this.grid=this.getGrid()):this.lastCW=g;var h=0,i=0,j=this.grid.columnX,k=j.length,l=!1;for(k;h<k;h++)if(i=j[h].x+j[h].w,d[0]<i){l=!0;break}l||h--;var m,n=0,o=0,p=!1,q=e.items.getAt(h),r=q.items.items,s=!1;for(k=r.length;n<k;n++)if(m=r[n],0===(o=m.el.getHeight()))s=!0;else if(m.el.getY()+o/2>d[1]){p=!0;break}n=(p&&m?n:q.items.getCount())+(s?-1:0);var t=this.createEvent(a,b,c,h,q,n);return!1!==e.fireEvent("validatedrop",t)&&!1!==e.fireEvent("beforedragover",t)?(f.getProxy().setWidth("auto"),m?a.panelProxy.moveProxy(m.el.dom.parentNode,p?m.el.dom:null):a.panelProxy.moveProxy(q.el.dom,null),this.lastPos={c:q,col:h,p:!!(s||p&&m)&&n},this.scrollPos=e.body.getScroll(),e.fireEvent("dragover",t),t.status):t.status},notifyOut:function(){delete this.grid},notifyDrop:function(a,b,c){if(delete this.grid,this.lastPos){var d=this.lastPos.c,e=this.lastPos.col,f=this.lastPos.p,g=a.panel,h=this.createEvent(a,b,c,e,d,!1!==f?f:d.items.getCount());if(Ext.suspendLayouts(),!1!==this.portal.fireEvent("validatedrop",h)&&!1!==this.portal.fireEvent("beforedrop",h)){g.el.dom.style.display="",!1!==f?d.insert(f,g):d.add(g),a.proxy.hide(),this.portal.fireEvent("drop",h);var i=this.scrollPos.top;if(i){var j=this.portal.body.dom;setTimeout(function(){j.scrollTop=i},10)}}return Ext.resumeLayouts(!0),delete this.lastPos,!0}},getGrid:function(){var a=this.portal.body.getBox();return a.columnX=[],this.portal.items.each(function(b){a.columnX.push({x:b.el.getX(),w:b.el.getWidth()})}),a},unreg:function(){Ext.dd.ScrollManager.unregister(this.portal.body),Ext.app.PortalDropZone.superclass.unreg.call(this),delete this.portal.afterLayout}}),Ext.define("KitchenSink.AdvancedVType",{override:"Ext.form.field.VTypes",daterange:function(a,b){var c=b.parseDate(a);if(!c)return!1;if(!b.startDateField||this.dateRangeMax&&c.getTime()==this.dateRangeMax.getTime()){if(b.endDateField&&(!this.dateRangeMin||c.getTime()!=this.dateRangeMin.getTime())){var d=b.up("form").down("#"+b.endDateField);d.setMinValue(c),this.dateRangeMin=c}}else{b.up("form").down("#"+b.startDateField).setMaxValue(c),this.dateRangeMax=c}return!0},daterangeText:"开始日期必须小于结束日期",monthrange:function(a,b){var c=b.getValue();if(!c)return!1;if(b.startDateField){var d=b.up("form").down("#"+b.startDateField),e=d.getValue();if(c<e)return!1}else if(b.endDateField){var f=b.up("form").down("#"+b.endDateField),e=f.getValue();if(c>e)return!1}return!0},monthrangeText:"开始日期必须小于结束日期",password:function(a,b){if(b.initialPassField){return a==b.up("form").down("#"+b.initialPassField).getValue()}return!0},passwordText:"密码不匹配"}),Ext.define("Sv.form.combobox",{extend:"Ext.form.field.ComboBox",alias:"widget.svcombobox",emptyText:"--请选择--",editable:!1,displayField:"propName",valueField:"propCode",queryMode:"local",isAll:!1,isNull:!1,svurl:Ext.actualUrl("/sys/propitem.json"),initComponent:function(){var a=this;a.callParent(arguments);var b=Ext.create("Ext.data.Store",{proxy:{type:"ajax",url:a.svurl,extraParams:{propertiesCode:a.svkey},reader:{type:"json"}},listeners:{load:function(b,c,d,e,f){if(a.isAll&&b.getCount()>0){var g=b.getAt(0);g&&"全部"!==g.data.propName&&b.insert(0,{propName:"全部",propCode:""}),a.isNull?b.insert(0,{propName:"",propCode:""}):a.setValue(g.data.propName)}}}});a.setStore(b),b.load()}}),Ext.define("Sv.Ext.QueryTree",{extend:"Ext.tree.Panel",alias:"widget.svquerytree",queryKey:"",isAutoQuery:2,isSearchtrigger:!0,isMultiselect:!1,queryParams:{},sysQuery:null,rootVisible:!1,checkPropagation:"both",animate:!1,useArrows:!0,defaultChecked:!1,initComponent:function(){var a=this;if(!a.sysQuery){var b=Sv.requestPostNoAsync("/sys/query_info.json",{key:a.queryKey},null,!1);b&&(a.sysQuery=b.query)}if(!a.sysQuery)return void Ext.log.error(queryKey+"查询表格初始化失败！");var c=Ext.decode(a.sysQuery.sqColumns);a.columns=c,a.callParent(arguments),a.setStore({autoLoad:3==a.isAutoQuery,proxy:{url:Ext.actualUrl(a.sysQuery.sqDataRul),type:"ajax",extraParams:a.queryParams},listeners:{load:function(b,c,d,e,f,g){a.isMultiselect&&f.cascade(function(b){b.set("checked",a.defaultChecked)}),a.expandAll()}}})},listeners:{afterrender:function(a){2==a.isAutoQuery&&a.store.getCount()<=1&&a.expandAll()}},loadData:function(a){var b=this;a&&(b.queryParams=a,b.store.proxy.extraParams=b.queryParams),b.store.load()},clearSelections:function(){if(this.isMultiselect){var a=this.getRootNode();a&&this.getView().setChecked(a,this.defaultChecked,null)}else{var b=this.getSelectionModel();b&&b.deselectAll()}this.expandAll()}}),Ext.define("Sv.Ext.QueryGrid",{extend:"Ext.grid.Panel",alias:"widget.svquerygrid",queryKey:"",isAutoQuery:2,isSearchtrigger:!0,isMultiselect:!1,queryParams:{},sysQuery:null,initComponent:function(){var a=this;if(a.isMultiselect&&(a.selModel={type:"checkboxmodel",checkOnly:!0}),a.callParent(arguments),!a.sysQuery){var b=Sv.requestPostNoAsync("/sys/query_info.json",{key:a.queryKey},null,!1);b&&(a.sysQuery=b.query)}if(!a.sysQuery)return void Ext.log.error(queryKey+"查询表格初始化失败！");var c=Ext.decode(a.sysQuery.sqColumns);if(a.isSearchtrigger)for(var d=0;d<c.length;d++)c[d].items={xtype:"searchtrigger",flex:1,margin:2};a.setColumns(c),a.setStore({autoLoad:3==a.isAutoQuery,proxy:{url:Ext.actualUrl(a.sysQuery.sqDataRul),type:"ajax",extraParams:a.queryParams,reader:{type:"json"}}})},listeners:{afterrender:function(a){2==a.isAutoQuery&&a.store.getCount()<=0&&a.store.load()}},loadData:function(a){var b=this;a&&(b.queryParams=a,b.store.proxy.extraParams=b.queryParams),b.store.load()},clearSelections:function(){var a=this.getSelectionModel();a&&a.deselectAll()}}),Ext.define("Sv.Ext.QueryWindow",{extend:"Ext.window.Window",alias:"widget.svquerywin",autoShow:!1,closeAction:"hide",defaultButton:"okButton",width:600,height:500,modal:!0,layout:"fit",queryKey:"",isAutoQuery:2,isSearchtrigger:!0,isMultiselect:!1,checkPropagation:"both",queryParams:{},sysQuery:null,items:[],mygrid:null,initComponent:function(){var a=this;if(a.callParent(arguments),!a.sysQuery){var b=Sv.requestPostNoAsync("/sys/query_info.json",{key:a.queryKey},null,!1);b&&(a.sysQuery=b.query)}if(!a.sysQuery)return void Ext.log.error(queryKey+"查询表格初始化失败！");a.getTitle()||a.setTitle(a.sysQuery.sqName);var c="Sv.Ext.QueryGrid";a.sysQuery.sqIsTree&&(c="Sv.Ext.QueryTree"),a.mygrid=Ext.create(c,{sysQuery:a.sysQuery,isAutoQuery:a.isAutoQuery,isSearchtrigger:a.isSearchtrigger,isMultiselect:a.isMultiselect,checkPropagation:a.checkPropagation,queryParams:a.queryParams,listeners:{celldblclick:function(a,b,c,d,e,f,g,h){var i=[d.data],j=a.up("window");j&&(j.fireEvent("selectok",j,a,i),j.hide())}}}),a.add(a.mygrid)},buttons:[{text:"刷新",handler:function(a,b){var c=this.up("window");c.mygrid&&c.mygrid.loadData(c.queryParams)}},{reference:"okButton",text:"确认",handler:function(){var a=this.up("window");if(a.mygrid){var b=[];b=a.sysQuery.sqIsTree&&a.isMultiselect?a.mygrid.getChecked():a.mygrid.getSelection();for(var c=[],d=0;d<b.length;d++)a.sysQuery.sqIsTree&&b[d].isRoot()||c.push(b[d].data);a.fireEvent("selectok",a,a.mygrid,c),a.mygrid.loadData(a.queryParams),a.hide()}}},{text:"取消",handler:function(a,b){var c=this.up("window");c.mygrid&&c.mygrid.loadData(c.queryParams),this.up("window").hide()}}],loadData:function(a){var b=this;b.mygrid&&b.mygrid.loadData(a)},clearSelections:function(){var a=this;a.mygrid&&a.mygrid.clearSelections()}}),Ext.define("Sv.Ext.QueryText",{extend:"Ext.form.field.Text",alias:"widget.svtrigger",myTitle:null,queryKey:"",isAutoQuery:2,isSearchtrigger:!0,isMultiselect:!1,checkPropagation:"both",queryParams:{},sysQuery:null,winWidth:600,winHeight:500,editable:!1,queryWin:{},initComponent:function(){var a=this;if(!a.sysQuery){var b=Sv.requestPostNoAsync("/sys/query_info.json",{key:a.queryKey},null,!1);b&&(a.sysQuery=b.query)}if(a.displayField=a.sysQuery.sqDisplayField,a.valueField=a.sysQuery.sqValueField,a.callParent(arguments),!a.sysQuery)return void Ext.log.error(queryKey+"查询表格初始化失败！");a.queryWin=Ext.create("Sv.Ext.QueryWindow",{title:a.myTitle,queryKey:a.queryKey,isAutoQuery:a.isAutoQuery,isSearchtrigger:a.isSearchtrigger,isMultiselect:a.isMultiselect,checkPropagation:a.checkPropagation,queryParams:a.queryParams,sysQuery:a.sysQuery,width:a.winWidth,height:a.winHeight,listeners:{selectok:function(b,c,d){a.setValue(d),a.fireEvent("selectok",b,c,d)}}})},triggers:{clear:{cls:Ext.baseCSSPrefix+"form-clear-trigger",handler:function(){this.setValue()}},picker:{cls:Ext.baseCSSPrefix+"form-search-trigger",handler:function(){this.queryWin.clearSelections(),this.queryWin.show()}}},getSubmitValue:function(){this.callParent();var a=this;if(a.isMultiselect){var b=[];if(Ext.isIterable(a.myvalue))for(var c=0;c<a.myvalue.length;c++)b.push(a.myvalue[c]);return b}return Ext.isIterable(a.myvalue)&&a.myvalue.length>0?a.myvalue[0]:Ext.isObject(a.myvalue)?a.myvalue:null},setValue:function(a){var b=this;b.myvalue=null,Ext.isString(a)&&a.length>0?Ext.Ajax.request({url:Ext.actualUrl(b.sysQuery.sqDataRul),method:"POST",params:{valueField:a},async:!1,success:function(a){var c=Ext.decode(a.responseText);Ext.isIterable(c)&&(b.myvalue=c)}}):b.myvalue=a;var c="";if(Ext.isIterable(b.myvalue))for(var d=0;d<b.myvalue.length;d++)0!=d&&(c+=","),c+=b.myvalue[d][b.displayField];return this.callParent([c]),b.myvalue},getValue:function(){var a=this,b="";if(Ext.isIterable(a.myvalue))for(var c=0;c<a.myvalue.length;c++)c>0&&(b+=","),b+=a.myvalue[c][a.valueField];else Ext.isObject(a.myvalue)&&(b=a.myvalue[a.valueField]);return a.value=b,b}}),Ext.define("Sv.Ext.QueryTextValue",{extend:"Sv.Ext.QueryText",alias:"widget.svtriggervalue",getSubmitValue:function(){this.callParent();var a=this;if(a.isMultiselect){var b="";if(Ext.isIterable(a.myvalue))for(var c=0;c<a.myvalue.length;c++)c>0&&(b+=","),b+=a.myvalue[c][a.valueField];return b}return Ext.isIterable(a.myvalue)&&a.myvalue.length>0?a.myvalue[0][a.valueField]:null}}),Ext.define("Sv.Ext.QueryButton",{extend:"Ext.button.Button",alias:"widget.svquerybutton",myTitle:null,queryKey:"",isAutoQuery:2,isSearchtrigger:!0,isMultiselect:!1,checkPropagation:"both",queryParams:{},sysQuery:null,winWidth:600,winHeight:500,queryWin:null,initComponent:function(){var a=this;if(a.callParent(arguments),!a.sysQuery){var b=Sv.requestPostNoAsync("/sys/query_info.json",{key:a.queryKey},null,!1);b&&(a.sysQuery=b.query)}if(!a.sysQuery)return void Ext.log.error(queryKey+"查询表格初始化失败！");a.displayField=a.sysQuery.sqDisplayField,a.valueField=a.sysQuery.sqValueField,a.queryWin=Ext.create("Sv.Ext.QueryWindow",{queryKey:a.queryKey,title:a.myTitle,isAutoQuery:a.isAutoQuery,isSearchtrigger:a.isSearchtrigger,isMultiselect:a.isMultiselect,checkPropagation:a.checkPropagation,queryParams:a.queryParams,sysQuery:a.sysQuery,width:a.winWidth,height:a.winHeight,listeners:{selectok:function(b,c,d){a.fireEvent("selectok",a,b,c,d)}}})},handler:function(){this.queryWin.clearSelections(),this.queryWin.show()},loadData:function(a){this.queryWin&&this.queryWin.loadData(a)}}),Ext.define("Sv.Ext.form.field.Month",{extend:"Ext.form.field.Date",alias:"widget.monthfield",requires:["Ext.picker.Month"],alternateClassName:["Ext.form.MonthField","Ext.form.Month"],selectMonth:null,format:"Y-m",createPicker:function(){var a,b=this,c=Ext.String.format;return a={pickerField:b,ownerCmp:b,renderTo:document.body,floating:!0,hidden:!0,focusOnShow:!0,minDate:b.minValue,maxDate:b.maxValue,disabledDatesRE:b.disabledDatesRE,disabledDatesText:b.disabledDatesText,disabledDays:b.disabledDays,disabledDaysText:b.disabledDaysText,format:b.format,showToday:b.showToday,startDay:b.startDay,minText:c(b.minText,b.formatDate(b.minValue)),maxText:c(b.maxText,b.formatDate(b.maxValue)),listeners:{select:{scope:b,fn:b.onSelect},monthdblclick:{scope:b,fn:b.onOKClick},yeardblclick:{scope:b,fn:b.onOKClick},OkClick:{scope:b,fn:b.onOKClick},CancelClick:{scope:b,fn:b.onCancelClick}},keyNavConfig:{esc:function(){b.collapse()}}},Ext.isChrome&&(b.originalCollapse=b.collapse,a.listeners.boxready={fn:function(){this.picker.el.on({mousedown:function(){this.collapse=Ext.emptyFn},mouseup:function(){this.collapse=this.originalCollapse},scope:this})},scope:b,single:!0}),Ext.create("Ext.picker.Month",a)},onCancelClick:function(){var a=this;a.selectMonth=null,a.collapse()},onOKClick:function(){var a=this;a.selectMonth?(a.setValue(a.selectMonth),a.fireEvent("select",a,a.selectMonth)):a.getPicker()&&(a.onSelect(a.getPicker(),a.getPicker().getValue()),a.setValue(a.selectMonth),a.fireEvent("select",a,a.selectMonth)),a.collapse()},onSelect:function(a,b){this.selectMonth=new Date(b[0]+1+"/1/"+b[1])}}),Ext.define("Sv.activiti.Toolbar",{extend:"Ext.toolbar.Toolbar",alias:"widget.toolbarActiviti",formSave:function(){return""},formClose:function(){return!1},formIsValid:function(){return!0},formCode:"",workformRun:null,queryWin:null,imgWin:null,parentLoadMask:null,opinions:[],init:function(a){if(a){var b=this,c=a.getValues(),d=[],e=!1;if(b.parentLoadMask=b.up().up(),c&&c.procInstId&&b.workformRun&&(e=b.setFieldsReadOnly(a,Ext.decode(b.workformRun.permission)),Ext.isObject(b.workformRun.permission)&&b.workformRun.permission.hasOwnProperty("all")&&0===b.workformRun.permission.all&&(e=!0),!c.state||8!=c.state&&9!=c.state||(b.setFieldsReadOnly(a,2),e=!1),b.imgWin||(b.imgWin=Ext.create("Ext.window.Window",{autoShow:!1,closeAction:"hide",title:"流程跟踪",tbar:[{text:"关闭",iconCls:"icon-cross",handler:function(a){var b=a.up("window");null!=b&&b.hide()}}],resizable:!1,maximized:!0,modal:!0,scrollable:!0,bodyPadding:10,items:[{xtype:"label",html:'<div style="font-size:25px;">流程图:<br /></div>',margin:"0 0 0 10"},{xtype:"image",src:Ext.actualUrl("/activiti/"+c.procInstId+"/processTracking.png")},{xtype:"label",html:'<div style="font-size:25px;"><br />意见:<br /></div>',margin:"0 5 5 10"},{xtype:"grid",width:1e3,animate:!1,margin:"5 5 5 10",frame:!0,store:{type:"store",autoLoad:!0,proxy:{type:"ajax",url:Ext.actualUrl("/activiti/task_opinion.json"),autoLoad:!0,extraParams:{procInstId:c.procInstId}}},columns:[{text:"流程节点",width:100,dataIndex:"name",menuDisabled:!0,sortable:!1},{text:"姓名",width:100,dataIndex:"userDisplayName",menuDisabled:!0,sortable:!1},{text:"时间",width:160,dataIndex:"createTime",menuDisabled:!0,sortable:!1},{text:"意见",flex:1,dataIndex:"text",menuDisabled:!0,sortable:!1}]}]})),Ext.isIterable(b.workformRun.branchesList))){var f=Sv.requestPostNoAsyncParams("/activiti/opinion/values.data",null);if(f&&f.data)for(var g=0;g<f.data.length;++g)b.opinions.push({text:f.data[g]});b.queryWin=Ext.create("Ext.window.Window",{autoShow:!1,closeAction:"hide",defaultButton:"okButton",title:"任务提交处理",width:600,height:600,modal:!0,layout:{type:"vbox",align:"stretch"},taskId:b.workformRun.taskId,bodyPadding:5,items:[{xtype:"fieldset",itemId:"fdseluser",baseCls:"x-fieldset{background-color: transparent; }",title:"审批",flex:1,padding:5,layout:"fit",items:[{xtype:"treepanel",selModel:{type:"checkboxmodel"},rootVisible:!1,checkPropagation:"both",store:{storeId:"TSStore",autoLoad:!1,proxy:{type:"ajax",url:Ext.actualUrl("/activiti/task_users.json")}},columns:[{text:"名称",dataIndex:"name",flex:1,xtype:"treecolumn",sortable:!0},{text:"账号 ",dataIndex:"userName",flex:1}]}]},{xtype:"fieldset",baseCls:"x-fieldset{background-color: transparent; }",title:"意见",height:160,padding:5,layout:"fit",items:[{xtype:"form",layout:"fit",flex:1,padding:"0 5 0 5",items:[{itemId:"tafOpinion",xtype:"textareafield",name:"opinion"}],tbar:{reference:"tbar",padding:"0 0 3 0",items:[{itemId:"cyyj",xtype:"splitbutton",text:"常用意见",menu:{items:b.opinions,listeners:{click:function(a,b,c,d){this.up("form").down("#tafOpinion").setValue(b.text)}}}},{xtype:"button",text:"保存为常用意见",handler:function(){var a=this.up("form"),b=a.down("#tafOpinion");if(b.getValue().length>1){var c=Sv.requestPostNoAsyncParams("/activiti/opinion/add.data",{opinion:b.getValue()});if(c&&2===c.status){a.down("#cyyj").menu.add({text:b.getValue()})}Ext.toast({html:"保存成功!",slideInDuration:400,minWidth:400})}}}]}}]}],buttons:[{reference:"okButton",text:"确认",handler:function(){var a=this.up("window");if(a.data.inputDataItem||a.data.assignee){var b=a.down("treepanel"),c=b.getSelection();if(!c||c.length<=0){var d=a.down("#fdseluser");return void Ext.MessageBox.alert("提示信息","请选择"+d.title)}a.data.assigneeList=[];for(var e=0;e<c.length;e++)1==c[e].data.type&&a.data.assigneeList.push(c[e].data.userName);if(a.data.assigneeList.length<=0){var d=a.down("#fdseluser");return void Ext.MessageBox.alert("提示信息","请选择"+d.title)}}var f=a.down("#tafOpinion");if(a.data.opinion=f.getValue(),!a.data.opinion||a.data.opinion.length<2)return void Ext.MessageBox.alert("提示信息","意见必须大于等于2个字。");Sv.requestPostNoAsync("/activiti/apply/completeTask.data",{taskId:a.taskId},a.data)&&location.reload(),a.hide()}},{text:"取消",handler:function(a,b){this.up("window").hide()}}]});for(var g=0;g<b.workformRun.branchesList.length;g++)d.push({text:b.workformRun.branchesList[g].name,data:b.workformRun.branchesList[g],iconCls:"icon-bullet_go",queryWin:b.queryWin,save:e,handler:function(a){var b=a.up("toolbarActiviti");if(b&&b.formIsValid()){if(a.save){var c=b.formSave();if(!c)return;Ext.isObject(c)&&(a.config.data.remark=c.remark)}var d=a.config.queryWin,e=d.down("#fdseluser");if(d.data=a.config.data,d.setTitle('提交"'+a.config.data.name+'"处理'),e.setTitle(a.config.data.name+"-人员"),a.config.data.inputDataItem||a.config.data.assignee){e.show();var f=d.down("treepanel");a.config.data.inputDataItem?f.getSelectionModel().setSelectionMode("MULTI"):f.getSelectionModel().setSelectionMode("SINGLE"),f.store.proxy.setExtraParams({candidateGroups:Ext.encode(a.config.data.candidateGroups)}),f.store.load(),f.expandAll(),a.config.queryWin.setHeight(600)}else e.hide(),a.config.queryWin.setHeight(270);d.show()}}})}c&&c.state&&0!=c.state||(d.push({itemId:"saveSubmit",text:"保存并启动流程",iconCls:"icon-disk_submit",loadingState:"启动中...",handler:function(a){var b=a.up("toolbarActiviti");null!=b&&(b.parentLoadMask&&b.parentLoadMask.setLoading("保存并启动流程中......",!0),Ext.defer(function(){var a=b.formSave();if(!a)return void(b.parentLoadMask&&b.parentLoadMask.setLoading(!1));var c={};if(Ext.isString(a)?(c.fguid=a,c.remark=""):Ext.isObject(a)&&(c=a),Sv.requestPostNoAsyncParams("/activiti/apply/start.data",{formCode:b.formCode,businessKey:c.fguid,remark:c.remark})){var d=location.pathname+"?mode=edit&fguid="+c.fguid;location=d}b.parentLoadMask&&b.parentLoadMask.setLoading(!1)},1,this))}}),b.setFieldsReadOnly(a,0),e=!0),e&&d.push({text:"保存",iconCls:"icon-disk",handler:function(a){var b=a.up("toolbarActiviti");null!=b&&(b.parentLoadMask&&b.parentLoadMask.setLoading("保存中......",!0),Ext.defer(function(){b.formSave()&&Ext.toast({html:"保存成功!",slideInDuration:400,minWidth:400}),b.parentLoadMask&&b.parentLoadMask.setLoading(!1)},1,this))}}),c&&c.procInstId&&d.push({text:"查看流程",iconCls:"icon-zoom",handler:function(a){a.up("toolbarActiviti").imgWin.show()}}),d.push({text:"关闭",iconCls:"icon-cross",handler:function(a){var b=a.up("toolbarActiviti");null!=b&&(b.formClose()||(window.target&&window.target.hide?window.target.hide():(window.location.href="about:blank",window.close())))}}),b.removeAll(),b.add(d)}},setFieldsReadOnly:function(a,b){var c=a.getFields().items,d=c.length;if(b){var e=!1;if(Ext.isObject(b)&&!b.hasOwnProperty("all"))for(f=0;f<d;f++)field=c[f],field instanceof Ext.form.field.Hidden||b.hasOwnProperty(field.name)&&(0==b[field.name]?(field.show(),field.setReadOnly(!1),field.setDisabled(!1),e=!0):1==b[field.name]?field.hide():2==b[field.name]?(field.show(),field.setReadOnly(!0),field.setDisabled(!1)):3==b[field.name]&&(field.show(),field.setDisabled(!0)));else{var g=b;for(Ext.isObject(b)&&b.hasOwnProperty("all")&&(g=b.all),f=0;f<d;f++)field=c[f],field instanceof Ext.form.field.Hidden||(0==g?(field.show(),field.setReadOnly(!1),field.setDisabled(!1),e=!0):1==g?field.hide():2==g?(field.show(),field.setReadOnly(!0),field.setDisabled(!1)):3==g&&(field.show(),field.setDisabled(!0)))}return e}}}),Ext.define("Sv.fileUpload",{extend:"Ext.panel.Panel",alias:"widget.svfileUpload",frame:!0,bodyPadding:5,parentTableId:"",attachType:"",readOnly:!1,tableGuid:"",items:[],delGuids:[],newInsert:[],initComponent:function(){var a=this;a.callParent(arguments),a.setReadOnly(a.readOnly)},tbar:{readOnlyHide:!0,items:[{xtype:"fileuploadfield",buttonOnly:!0,hideLabel:!0,buttonText:"添加附件",width:80,listeners:{change:function(a){var b=a.fileInputEl.dom.files[0],c=this.up("panel"),d={xtype:"container",layout:"hbox",margin:"0 0 5 0",bodyPadding:5,height:32,style:"background-color: #f1f1f1;",items:[{xtype:"hiddenfield",name:"saGuid"},{xtype:"label",flex:1,margin:"5 5 0 5",text:b.name},{xtype:"progressbar",text:"...",width:150,height:24,margin:"4 5 0 0",file:b,listeners:{afterrender:function(a){var b=new XMLHttpRequest,d=a.nextSibling("button"),e=a.previousSibling("[name=saGuid]"),f=a.previousSibling("label");b.upload.addEventListener("progress",function(b){var c=Math.round(100*b.loaded/b.total);a.updateProgress(c/100,c+"%")},!1),b.upload.addEventListener("error",function(b){console.log("错误！"),a.hide(),d.show()},!1),b.upload.addEventListener("abort",function(b){console.log("中断！"),a.hide(),d.show()},!1),b.open("POST",Ext.actualUrl("/sys/upload_attachment.data"),!0);var g=new FormData;g.append("file",a.file),g.append("parentTableId",c.parentTableId),g.append("attachType",c.attachType),g.append("tableGuid",c.tableGuid),b.onreadystatechange=function(b){if(4==this.readyState&&200==this.status){var g=Ext.decode(this.responseText);if(g){e.setValue(g.saGuid),c.tableGuid.length<1&&c.newInsert.push(g.saGuid);var h="<a href='"+Ext.actualUrl("/sys/attachment_down.html?id="+g.saGuid)+"'>"+a.file.name+"</a>";f.setHtml(h)}a.hide(),d.show()}},b.send(g)}}},{xtype:"button",icon:Ext.actualUrl("/ico/drop-no.png"),width:40,hidden:!0,readOnlyHide:!0,tooltip:"删除",style:"border-color: transparent !important;background: transparent !important;",handler:function(){var a=this.previousSibling("[name=saGuid]"),b=this.up("container");c.delGuids.push(a.getValue());var d=c.newInsert.indexOf(a.getValue());d>-1&&c.newInsert.splice(d,1),c.remove(b)}}]};c.add(d)}}}]},setValue:function(a){loadFiles(a)},setReadOnly:function(a){var b=this.query("*[readOnlyHide=true]");if(Ext.isIterable(b))for(var c=0;c<b.length;++c)a?b[c].hide():b[c].show()},saveFiles:function(a){if(this.tableGuid=a,Ext.isIterable(this.delGuids)&&this.delGuids.length>0){Sv.requestPostNoAsyncJsonData("/sys/attachment_delete.data",this.delGuids)}if(Ext.isIterable(this.newInsert)&&this.newInsert.length>0){for(var b=[],c=0;c<this.newInsert.length;++c)b.push({saGuid:this.newInsert[c],parentTableGuid:a});Sv.requestPostNoAsyncJsonData("/sys/attachment_update.data",b);this.newInsert=[]}},loadFiles:function(a){var b=this;b.tableGuid=a;var c=Sv.requestPostNoAsyncParams("/sys/attachment.json",{parentTableId:b.parentTableId,parentTableGuid:a,attachType:b.attachType});if(c&&(this.newInsert=[],this.delGuids=[],Ext.isIterable(c.data))){b.removeAll();for(var d=0;d<c.data.length;++d){var e="<a href='"+Ext.actualUrl("/sys/attachment_down.html?id="+c.data[d].saGuid)+"'>"+c.data[d].attachName+"</a>",f={xtype:"container",layout:"hbox",margin:"0 0 5 0",bodyPadding:5,height:32,style:"background-color: #f1f1f1;",items:[{xtype:"hiddenfield",name:"saGuid",value:c.data[d].saGuid},{xtype:"label",flex:1,margin:"5 5 0 5",html:e},{xtype:"button",icon:Ext.actualUrl("/ico/drop-no.png"),width:40,readOnlyHide:!0,tooltip:"删除",hidden:b.readOnly,style:"border-color: transparent !important;background: transparent !important;",handler:function(){var a=this.previousSibling("[name=saGuid]"),c=this.up("container");b.delGuids.push(a.getValue());var d=b.newInsert.indexOf(a.getValue());d>-1&&b.newInsert.splice(d,1),b.remove(c)}}]};b.add(f)}}}});